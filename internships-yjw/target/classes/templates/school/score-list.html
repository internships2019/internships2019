<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>学生成绩</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="stylesheet" th:href="@{/css/font.css}" href="./css/font.css">
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" href="./css/xadmin.css">
    <script th:src="@{/layui/layui.js}" src="layui/layui.js" charset="utf-8"></script>
</head>
<body style="margin: 20px;">
    <a class="layui-btn layui-btn-sm " style="float:right" href="javascript:location.replace(location.href);" title="刷新"><i class="layui-icon" style="line-height:30px">&#xe669;</i></a>
    <div class="demoTable">
        <div class="layui-inline">
            <input class="layui-input" style="width: 200px;height: 30px;" placeholder="学生姓名" name="studentName" id="studentName" autocomplete="off">
        </div>
        <button class="layui-btn layui-btn-sm" style="margin-left: 10px" id="search"><i class="layui-icon">&#xe615;</i>搜索</button>
    </div>
    <table class="layui-hide"  id="class" lay-filter="class"></table>
    <!--数据表格左侧工具栏-->
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm " lay-event="batchUpdate"><i class="layui-icon">&#xe631;</i>批量修改成绩</button>
            <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="scoreStandard"><i class="layui-icon">&#xe609;</i>分值占比</button>
        </div>
    </script>
    <!--数据表格操作选项中的按钮-->
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">修改考勤成绩</a>
    </script>
    <script>
        var callData=null;
        layui.use(['form','table','layer','jquery'],function () {
            var table=layui.table;
            var layer=layui.layer;
            var $=layui.jquery;
            var tableIns=null;
            var user=null;

            $.ajax({
                url:"/internships/manager/get_manager_information"
                ,success:function (res) {
                    user=JSON.parse(res);
                    //表格构造

                    tableIns=table.render({
                        elem: '#class'
                        ,url:'/internships/score/find_score_list'
                        ,height:400
                        ,cellMinWidth: 80
                        ,toolbar:'default'
                        ,page:true
                        ,toolbar: '#toolbarDemo'
                        ,where:{
                            unitName:user.manNuitName,
                            status:'学校'
                        }
                        ,cols: [
                            [
                                {type: 'checkbox', fixed: 'left'}
                                ,{field:'className',width:200,title: '学号',align:"center",templet:'<div>{{d.student.sNo}}</div>'}
                                ,{field:'collegeName', title: '姓名',align:"center",templet:'<div>{{d.student.sName}}</div>'}
                                ,{field:'sSex',width:80, title: '性别',align:"center",templet:'<div>{{d.student.sSex}}</div>'}
                                ,{field:'className', title: '班级',width:180,align:"center",templet:'<div>{{d.student.className}}</div>'}
                                ,{field:'attanScore',title: '考勤成绩',align:"center"}
                                ,{field:'apprScore',title: '考核成绩',align:"center",templet:function (d) {
                                    if (d.apprScore != null){
                                        return '<div>'+d.apprScore+'</div>'
                                    }
                                    return '<div>考核成绩暂未录入</div>'
                                }}
                                ,{field:'intagrateScore',width:120, title: '综合总成绩',align:"center",templet:function (d) {
                                    if (d.intagrateScore != null){
                                        return '<div >'+d.intagrateScore+'</div>'
                                    }
                                    return '<div>总成绩暂未生成</div>'
                                }}
                                ,{field:'right',title:'操作',toolbar:'#barDemo',align:"center"}
                            ]
                        ]
                    });



                }
            });

            //学生名搜索
            $('#search').click(function () {
                tableIns.reload({
                    url:'/internships/score/find_score_byName'
                    ,where:{sScName:user.manNuitName,stuName:$('#studentName').val()}
                });
            });


            //左侧工具栏事件
            table.on('toolbar(class)',function (obj) {
                switch (obj.event) {
                    //分值占比
                    case 'scoreStandard':
                        layer.open({
                            type: 2,
                            title: '成绩分值占比情况',
                            shade:0.5,//设置弹窗背景遮蔽
                            shadeClose: true,
                            maxmin: true, //开启最大化最小化按钮
                            area: ['800px', '460px'],//
                            scrollbar: false,
                            content: '/internships/school-score-standard'
                            ,success:function (layero,index) {
                                // 获取子页面的iframe
                                var iframe = window['layui-layer-iframe' + index];
                                // 向子页面的全局函数child传参
                                iframe.child(user.manNuitName);
                            }
                        });
                        break;
                    //批量修改成绩
                    case 'batchUpdate':
                        var checkStatus = table.checkStatus(obj.config.id);
                        if(checkStatus.data==""){
                            layer.msg("请选中至少一行!",{icon:5});
                        }else {
                            layer.prompt({title: '请输入考勤新成绩!'}, function(text, index){
                                var re= /^((0{1}\.\d+)|([1-9]\d*\.{1}\d+)|([1-9]+\d*)|0)$/;
                                if (text==''){
                                    layer.msg("输入成绩不能为空!");
                                }
                                else if (!re.test(text)){
                                    layer.msg("成绩必须为数字!");
                                }else if(text>100){
                                    layer.msg("成绩必须为小于等于一百的正整数!");
                                } else {
                                    $.ajax({
                                        url:'/internships/score/batch_update',
                                        type:'post',
                                        contentType: 'application/json',
                                        dataType:'text',
                                        data:JSON.stringify({
                                            list:checkStatus.data,
                                            sScName:user.manNuitName,
                                            attanScore:text
                                        }),
                                        success:function () {
                                            layer.msg("批修改成功!");
                                            tableIns.reload();
                                            layer.close(index);
                                        }
                                    });
                                }
                            });
                        }
                        break;
                }
            });

            //监听行单击事件
            table.on('tool(class)', function(obj){
                switch (obj.event) {
                    //修改功能
                    case 'edit':
                        layer.prompt({title: '请输入考勤新成绩!'}, function(text, index){
                            var re= /^((0{1}\.\d+)|([1-9]\d*\.{1}\d+)|([1-9]+\d*)|0)$/;
                            if (text==''){
                                layer.msg("输入成绩不能为空!");
                            }
                            else if (!re.test(text)){
                                layer.msg("成绩必须为数字!");
                            }else if(text>100){
                                layer.msg("成绩必须为小于等于一百的正整数!");
                            } else {
                                obj.data.attanScore=text;
                                $.ajax({
                                    url:'/internships/score/edit_attanScore',
                                    type:'post'
                                    ,contentType: 'application/json'
                                    ,dataType:'text'
                                    ,data:JSON.stringify(obj.data),
                                    success:function (res) {
                                       if (res!=null){
                                           layer.msg("考勤成绩修改成功!");
                                           var data=JSON.parse(res);
                                           obj.update({
                                               attanScore:data.attanScore,
                                               intagrateScore:data.intagrateScore
                                           });
                                           layer.close(index);
                                       }else {
                                           layer.msg("后台接口异常!");
                                       }
                                    }
                                });
                            }
                        });
                        break;
                }
            });


        });
    </script>
</body>
</html>